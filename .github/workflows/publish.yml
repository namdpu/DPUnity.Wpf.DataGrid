name: Publish NuGet Package to GitHub Packages

on:
  push:
    branches:
      - nuget

env:
  DISCORD_WEBHOOK: https://discordapp.com/api/webhooks/1402490419530432665/hFcn7hExzZ20MgLpbmGjdF4cwu3YpB5z4k5G01484Jouwl9GNWMxcJi-pYJZjexLFMch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore ./src/DPUnity.Wpf.DpDataGrid.csproj

    - name: Build
      run: dotnet build ./src/DPUnity.Wpf.DpDataGrid.csproj --configuration Release

    - name: Pack NuGet package
      run: dotnet pack ./src/DPUnity.Wpf.DpDataGrid.csproj --configuration Release --output ./nupkg

    - name: Upload NuGet package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: ./nupkg/*.nupkg

    - name: Notify Discord - Build Success
      if: success()
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
      with:
        args: |
          âœ… **Build Success** - DPU WPF DataGrid NuGet Package
          ğŸ“¦ Project built and packed successfully
          ğŸ”— Repository: ${{ github.repository }}
          ğŸ‘¤ Author: ${{ github.actor }}

    - name: Notify Discord - Build Failed
      if: failure()
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
      with:
        args: |
          âŒ **Build Failed** - DPU WPF DataGrid NuGet Package
          ğŸ’¥ Failed to build or pack the project
          ğŸ”— Repository: ${{ github.repository }}
          ğŸ‘¤ Author: ${{ github.actor }}
          ğŸ“ Commit: `${{ github.sha }}`
          ğŸ” Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  deploy:
    needs: build
    runs-on: windows-latest
    if: success() # Chá»‰ cháº¡y khi build thÃ nh cÃ´ng

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download NuGet package artifacts
      uses: actions/download-artifact@v4
      with:
        name: nuget-package
        path: ./nupkg

    - name: Authenticate to GitHub Packages
      shell: pwsh
      run: |
        dotnet nuget remove source github || echo "No existing 'github' source found."
        dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
          --name github `
          --username "${{ github.actor }}" `
          --password "${{ secrets.GIT_TOKEN }}" `
          --store-password-in-clear-text

    - name: Find .nupkg file
      id: find_nupkg
      shell: pwsh
      run: |
        $file = Get-ChildItem -Path ./nupkg -Filter *.nupkg | Select-Object -ExpandProperty FullName
        echo "NUPKG_PATH=$file" >> $env:GITHUB_ENV

    - name: Push to GitHub Packages
      shell: pwsh
      run: |
        echo "Using package: $env:NUPKG_PATH"
        dotnet nuget push "$env:NUPKG_PATH" `
          --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
          --api-key "${{ secrets.GIT_TOKEN }}" `
          --skip-duplicate

    - name: Get package info
      id: package_info
      shell: pwsh
      run: |
        $nupkgFile = Get-ChildItem -Path ./nupkg -Filter *.nupkg | Select-Object -First 1
        $packageName = $nupkgFile.Name -replace '\.nupkg$', ''
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV
        echo "Package: $packageName"
        
        # Extract version from package name (assuming format: PackageName.Version.nupkg)
        if ($packageName -match '\.(\d+\.\d+\.\d+(?:\.\d+)?)$') {
          $version = $matches[1]
          echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
          echo "Version: $version"
        }

    - name: Notify Discord - Deploy Success
      if: success()
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
      with:
        args: |
          ğŸ“¦ **Deploy Success** - DPU WPF DataGrid NuGet Package
          âœ… Package published to GitHub Packages successfully
          ğŸ·ï¸ Package: ${{ env.PACKAGE_NAME }}
          ğŸ”— Version: ${{ env.PACKAGE_VERSION }}
          ğŸ”— Repository: ${{ github.repository }}
          ğŸ‘¤ Author: ${{ github.actor }}

    - name: Notify Discord - Deploy Failed
      if: failure()
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
      with:
        args: |
          âŒ **Deploy Failed** - DPU WPF DataGrid NuGet Package
          ğŸ’¥ Failed to publish package to GitHub Packages
          ğŸ”— Repository: ${{ github.repository }}
          ğŸ‘¤ Author: ${{ github.actor }}
          ğŸ“ Commit: `${{ github.sha }}`
          ğŸ” Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
